---
- name: Ensure required variables are defined for servers
  ansible.builtin.assert:
    that:
      - k3s_cluster_token is defined
      - k3s_channel is defined
      - inventory_hostname in groups['control_plane']
      - (k3s_api_endpoint is defined) or (inventory_hostname == groups['control_plane'][0])
    fail_msg: "k3s_cluster_token and k3s_api_endpoint must be defined for control-plane installation."

- name: Determine node IP for k3s
  ansible.builtin.set_fact:
    k3s_node_ip: "{{ ansible_default_ipv4.address }}"

- name: Check if this server initializes the cluster
  ansible.builtin.set_fact:
    k3s_cluster_init: "{{ inventory_hostname == groups['control_plane'][0] }}"

- name: Determine primary control-plane host
  ansible.builtin.set_fact:
    k3s_primary_control_plane: "{{ groups['control_plane'][0] }}"

- name: Determine primary control-plane IP
  ansible.builtin.set_fact:
    k3s_primary_control_plane_ip: "{{ hostvars[k3s_primary_control_plane].k3s_static_ipv4 | default('', true) | regex_replace('/.*$', '') }}"

- name: Calculate effective API endpoint
  ansible.builtin.set_fact:
    k3s_effective_api_endpoint: >-
      {{
        (k3s_api_endpoint | default('') | trim)
        or (k3s_primary_control_plane_ip | default('') | trim)
        or (hostvars[k3s_primary_control_plane].get('ansible_host', k3s_primary_control_plane))
      }}

- name: Build TLS SAN entries
  ansible.builtin.set_fact:
    k3s_server_tls_sans_effective: "{{ (k3s_server_tls_sans + [inventory_hostname]) | unique }}"

- name: Ensure k3s configuration directory exists
  ansible.builtin.file:
    path: /etc/rancher/k3s
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Render minimal k3s server config
  ansible.builtin.template:
    src: config.yaml.j2
    dest: /etc/rancher/k3s/config.yaml
    owner: root
    group: root
    mode: "0640"
  notify: restart k3s

- name: Build k3s server exec arguments
  ansible.builtin.set_fact:
    k3s_server_exec_args: >-
      {{
        ['server']
        + (['--cluster-init'] if k3s_cluster_init else ['--server https://' ~ k3s_effective_api_endpoint ~ ':6443'])
        + ['--write-kubeconfig-mode 0640']
        + (k3s_server_disable_components | map('regex_replace', '^(.*)$', '--disable \\1') | list)
      }}

- name: Wait for primary control-plane API
  ansible.builtin.wait_for:
    host: "{{ k3s_effective_api_endpoint }}"
    port: 6443
    delay: 5
    timeout: 180
    state: started
  when:
    - not k3s_cluster_init
    - not (ansible_check_mode | default(false))

- block:
    - name: Install k3s server
      ansible.builtin.shell:
        cmd: "curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC='{{ k3s_server_exec_args | join(' ') }}' INSTALL_K3S_CHANNEL='{{ k3s_channel }}' INSTALL_K3S_SKIP_DOWNLOAD=false INSTALL_K3S_FORCE_RESTART=true sh -"
      environment:
        K3S_TOKEN: "{{ k3s_cluster_token }}"
        K3S_NODE_NAME: "{{ inventory_hostname }}"
        K3S_NODE_IP: "{{ k3s_node_ip }}"
        K3S_URL: "{{ ('https://' ~ k3s_effective_api_endpoint ~ ':6443') if not k3s_cluster_init else omit }}"
      when: not (ansible_check_mode | default(false))
  rescue:
    - name: Capture k3s server service status
      ansible.builtin.command: systemctl status k3s --no-pager
      register: k3s_service_status
      ignore_errors: true

    - name: Show k3s server service status
      ansible.builtin.debug:
        var: k3s_service_status.stdout_lines
      when: k3s_service_status is defined and (k3s_service_status.stdout | default('') | length > 0)

    - name: Capture k3s server journal
      ansible.builtin.command: journalctl -xeu k3s --no-pager -n 200
      register: k3s_service_journal
      ignore_errors: true

    - name: Show k3s server journal excerpt
      ansible.builtin.debug:
        var: k3s_service_journal.stdout_lines
      when: k3s_service_journal is defined and (k3s_service_journal.stdout | default('') | length > 0)

    - name: Fail k3s server installation
      ansible.builtin.fail:
        msg: "k3s server installation failed on {{ inventory_hostname }}. See collected status/journal output above."

- name: Ensure k3s service is enabled
  ansible.builtin.systemd:
    name: k3s
    enabled: true
    state: started
  when: not (ansible_check_mode | default(false))
