- name: Determine primary control-plane host
  ansible.builtin.set_fact:
    post_bootstrap_primary_control_plane: "{{ groups['control_plane'][0] }}"

- name: Calculate effective API endpoint
  ansible.builtin.set_fact:
    post_bootstrap_effective_api_endpoint: "{{ k3s_api_endpoint | default(hostvars[post_bootstrap_primary_control_plane].inventory_hostname) }}"

- name: Wait for Kubernetes API to become reachable
  ansible.builtin.wait_for:
    host: "{{ post_bootstrap_effective_api_endpoint }}"
    port: 6443
    delay: 5
    timeout: "{{ post_bootstrap_wait_timeout }}"
    state: started

- name: Read kubeconfig from control-plane node
  ansible.builtin.slurp:
    src: /etc/rancher/k3s/k3s.yaml
  register: raw_kubeconfig

- name: Prepare local kubeconfig directory
  ansible.builtin.file:
    path: "{{ post_bootstrap_local_kubeconfig | dirname }}"
    state: directory
    mode: "0700"
  delegate_to: localhost
  become: false

- name: Write kubeconfig with updated server endpoint
  ansible.builtin.copy:
    content: "{{ raw_kubeconfig.content | b64decode | regex_replace('https://127.0.0.1:6443', 'https://' ~ post_bootstrap_effective_api_endpoint ~ ':6443') }}"
    dest: "{{ post_bootstrap_local_kubeconfig }}"
    mode: "0600"
  delegate_to: localhost
  become: false

- name: Display kubeconfig path for operators
  ansible.builtin.debug:
    msg: "Updated kubeconfig written to {{ post_bootstrap_local_kubeconfig }}"
