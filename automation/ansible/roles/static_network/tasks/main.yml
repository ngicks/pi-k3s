---
- name: Ensure static IPv4 address is provided
  ansible.builtin.assert:
    that:
      - static_ipv4 is defined
      - "(static_ipv4 | split('/') | length) == 2"
      - "(static_ipv4 | string | length) >= 7"
    fail_msg: "static_ipv4 must be defined (CIDR format, e.g. 192.168.10.10/24)."

- name: Gather current IPv4 interface assignments
  ansible.builtin.command: ip -4 -j a
  register: ip_4_j_a 
  changed_when: false

- name: Find matching interface
  ansible.builtin.set_fact:
    target_interface: "{{ item.ifname }}"
  when: item.addr_info | selectattr('broadcast', 'defined') | selectattr('broadcast', 'equalto', target_broadcast) | list | length > 0
  loop: "{{ ip_4_j_a.stdout | from_json }}"
  vars:
    target_broadcast: "{{ local_broadcast }}"

- name: Ensure target_interface is found
  ansible.builtin.assert:
    that:
      - target_interface is defined
      - "(target_interface | string | length) >= 3"

- name: Render netplan configuration for {{ target_interface }}
  ansible.builtin.template:
    src: netplan-static.yaml.j2
    dest: "/etc/netplan/99-k3s-static-{{ target_interface }}.yaml"
    owner: root
    group: root
    mode: "0600"
  register: netplan_template

- name: netplan generate
  ansible.builtin.command: netplan generate
  become: yes

- name: Record netplan change status
  ansible.builtin.set_fact:
    netplan_changed: "{{ (netplan_template is defined) and netplan_template.changed }}"
