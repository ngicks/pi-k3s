---
- name: Ensure static IPv4 address is provided
  ansible.builtin.assert:
    that:
      - static_ipv4 is defined
      - "(static_ipv4 | split('/') | length) == 2"
      - "(static_ipv4 | string | length) >= 7"
    fail_msg: "static_ipv4 must be defined (CIDR format, e.g. 192.168.10.10/24)."

- name: Gather current IPv4 interface assignments
  ansible.builtin.command: ip -4 -j addr
  register: static_ip_addr_output
  changed_when: false

- name: Parse IPv4 interface assignments
  ansible.builtin.set_fact:
    static_ipv4_interfaces_raw: "{{ (static_ip_addr_output.stdout | default('[]')) | from_json }}"

- name: Build interface candidate list
  ansible.builtin.set_fact:
    static_interface_candidates: >-
      {{
        static_ipv4_interfaces_raw
        | selectattr('ifname', 'defined')
        | rejectattr('ifname', 'equalto', 'lo')
        | map(attribute='ifname')
        | unique
        | list
      }}

- name: Derive effective interface name
  ansible.builtin.set_fact:
    static_interface_effective: >-
      {{
        static_interface
        | default((static_interface_candidates | default([])) | first, true)
      }}

- name: Render netplan configuration for {{ static_interface_effective }}
  ansible.builtin.template:
    src: netplan-static.yaml.j2
    dest: "/etc/netplan/99-k3s-static-{{ static_interface_effective }}.yaml"
    owner: root
    group: root
    mode: "0600"
  register: netplan_template

- name: Record netplan change status
  ansible.builtin.set_fact:
    netplan_changed: "{{ (netplan_template is defined) and netplan_template.changed }}"
