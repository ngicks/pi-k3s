---
- name: Ensure required variables are defined for agents
  ansible.builtin.assert:
    that:
      - k3s_cluster_token is defined
      - k3s_channel is defined
    fail_msg: "k3s_cluster_token and k3s_channel must be provided for agent nodes."

- name: Determine node IP for agent
  ansible.builtin.set_fact:
    k3s_node_ip: "{{ ansible_default_ipv4.address }}"

- name: Determine primary control-plane host
  ansible.builtin.set_fact:
    k3s_primary_control_plane: "{{ groups['control_plane'][0] }}"

- name: Calculate effective API endpoint
  ansible.builtin.set_fact:
    k3s_agent_effective_api_endpoint: "{{ k3s_api_endpoint | default(hostvars[k3s_primary_control_plane].inventory_hostname) }}"

- name: Build label arguments
  ansible.builtin.set_fact:
    k3s_agent_label_args: "{{ k3s_agent_labels | map('regex_replace', '^(.*)$', '--node-label \\1') | list }}"

- name: Build taint arguments
  ansible.builtin.set_fact:
    k3s_agent_taint_args: "{{ k3s_agent_taints | map('regex_replace', '^(.*)$', '--node-taint \\1') | list }}"

- name: Compose agent exec arguments
  ansible.builtin.set_fact:
    k3s_agent_exec_args: "{{ ['agent', '--node-ip ' ~ k3s_node_ip] + k3s_agent_label_args + k3s_agent_taint_args }}"

- name: Check for existing k3s binary
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Install k3s agent
  ansible.builtin.shell: curl -sfL https://get.k3s.io | sh -
  environment:
    K3S_TOKEN: "{{ k3s_cluster_token }}"
    K3S_URL: "https://{{ k3s_agent_effective_api_endpoint }}:6443"
    INSTALL_K3S_CHANNEL: "{{ k3s_channel }}"
    K3S_NODE_NAME: "{{ inventory_hostname }}"
    K3S_NODE_IP: "{{ k3s_node_ip }}"
    INSTALL_K3S_EXEC: "{{ k3s_agent_exec_args | join(' ') }}"
  when: not k3s_binary.stat.exists

- name: Ensure k3s-agent service is enabled
  ansible.builtin.systemd:
    name: k3s-agent
    enabled: true
    state: started
  when: not ansible_check_mode
