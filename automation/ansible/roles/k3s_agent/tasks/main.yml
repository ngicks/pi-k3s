---
- name: Ensure required variables are defined for agents
  ansible.builtin.assert:
    that:
      - k3s_cluster_token is defined
      - k3s_channel is defined
    fail_msg: "k3s_cluster_token and k3s_channel must be provided for agent nodes."

- name: Determine node IP for agent
  ansible.builtin.set_fact:
    k3s_node_ip: "{{ ansible_default_ipv4.address }}"

- name: Determine primary control-plane host
  ansible.builtin.set_fact:
    k3s_primary_control_plane: "{{ groups['control_plane'][0] }}"

- name: Determine primary control-plane IP
  ansible.builtin.set_fact:
    k3s_primary_control_plane_ip: "{{ hostvars[k3s_primary_control_plane].k3s_static_ipv4 | default('', true) | regex_replace('/.*$', '') }}"

- name: Calculate effective API endpoint
  ansible.builtin.set_fact:
    k3s_agent_effective_api_endpoint: >-
      {{
        (k3s_api_endpoint | default('') | trim)
        or (k3s_primary_control_plane_ip | default('') | trim)
        or (hostvars[k3s_primary_control_plane].get('ansible_host', k3s_primary_control_plane))
      }}

- name: Build label arguments
  ansible.builtin.set_fact:
    k3s_agent_label_args: "{{ k3s_agent_labels | map('regex_replace', '^(.*)$', '--node-label \\1') | list }}"

- name: Build taint arguments
  ansible.builtin.set_fact:
    k3s_agent_taint_args: "{{ k3s_agent_taints | map('regex_replace', '^(.*)$', '--node-taint \\1') | list }}"

- name: Compose agent exec arguments
  ansible.builtin.set_fact:
    k3s_agent_exec_args: "{{ ['agent', '--node-ip ' ~ k3s_node_ip] + k3s_agent_label_args + k3s_agent_taint_args }}"

- block:
    - name: Install k3s agent
      ansible.builtin.shell: "curl -sfL https://get.k3s.io | sh -"
      environment:
        K3S_TOKEN: "{{ k3s_cluster_token }}"
        K3S_URL: "https://{{ k3s_agent_effective_api_endpoint }}:6443"
        INSTALL_K3S_CHANNEL: "{{ k3s_channel }}"
        K3S_NODE_NAME: "{{ inventory_hostname }}"
        K3S_NODE_IP: "{{ k3s_node_ip }}"
        INSTALL_K3S_EXEC: "{{ k3s_agent_exec_args | join(' ') }}"
      when: not (ansible_check_mode | default(false))
  rescue:
    - name: Capture k3s-agent service status
      ansible.builtin.command: systemctl status k3s-agent --no-pager
      register: k3s_agent_service_status
      ignore_errors: true

    - name: Show k3s-agent service status
      ansible.builtin.debug:
        var: k3s_agent_service_status.stdout_lines
      when: k3s_agent_service_status is defined and (k3s_agent_service_status.stdout | default('') | length > 0)

    - name: Capture k3s-agent journal
      ansible.builtin.command: journalctl -xeu k3s-agent --no-pager -n 200
      register: k3s_agent_service_journal
      ignore_errors: true

    - name: Show k3s-agent journal excerpt
      ansible.builtin.debug:
        var: k3s_agent_service_journal.stdout_lines
      when: k3s_agent_service_journal is defined and (k3s_agent_service_journal.stdout | default('') | length > 0)

    - name: Fail k3s agent installation
      ansible.builtin.fail:
        msg: "k3s agent installation failed on {{ inventory_hostname }}. See collected status/journal output above."

- name: Ensure k3s-agent service is enabled
  ansible.builtin.systemd:
    name: k3s-agent
    enabled: true
    state: started
  when: not (ansible_check_mode | default(false))
