---
- name: Locate existing netplan configuration
  ansible.builtin.find:
    paths: /etc/netplan
    patterns: "*.yaml"
    file_type: file
  register: k3s_netplan_find
  when: k3s_static_ipv4 is defined

- name: Choose primary netplan file
  ansible.builtin.set_fact:
    k3s_netplan_source: "{{ (k3s_netplan_find.files | sort(attribute='path'))[0].path }}"
  when:
    - k3s_static_ipv4 is defined
    - k3s_netplan_find.files | length > 0

- name: Load existing netplan configuration
  ansible.builtin.slurp:
    src: "{{ k3s_netplan_source }}"
  register: k3s_netplan_raw
  when:
    - k3s_static_ipv4 is defined
    - k3s_netplan_source is defined

- name: Parse netplan configuration
  ansible.builtin.set_fact:
    k3s_netplan_config: "{{ k3s_netplan_raw.content | b64decode | from_yaml }}"
  when:
    - k3s_static_ipv4 is defined
    - k3s_netplan_raw is defined

- name: Determine existing netplan interfaces
  ansible.builtin.set_fact:
    k3s_netplan_interfaces: "{{ (k3s_netplan_config.network.ethernets | default({})).keys() | list }}"
  when:
    - k3s_static_ipv4 is defined
    - k3s_netplan_config is defined

- name: Compute static network settings
  ansible.builtin.set_fact:
    k3s_static_interface_effective: "{{ k3s_static_interface | default((k3s_netplan_interfaces | default([]))[0] if (k3s_netplan_interfaces | default([]) | length > 0) else 'eth0') }}"
    k3s_static_dns_effective: "{{ k3s_static_dns | default([k3s_static_router], true) }}"
  when: k3s_static_ipv4 is defined

- name: "[Debug] print determined interface name"
  ansible.builtin.debug:
    var: k3s_static_interface_effective
  
- name: Remove legacy dhcpcd static configuration
  ansible.builtin.blockinfile:
    path: /etc/dhcpcd.conf
    marker: "# {mark} ANSIBLE K3S STATIC NETWORK"
    state: absent
  when: k3s_static_ipv4 is defined

- name: Render netplan configuration for {{ k3s_static_interface_effective | default('eth0') }}
  ansible.builtin.template:
    src: netplan-static.yaml.j2
    dest: "/etc/netplan/99-k3s-static-{{ k3s_static_interface_effective | default('eth0') }}.yaml"
    owner: root
    group: root
    mode: "0644"
  when: k3s_static_ipv4 is defined
  register: netplan_template

- name: Record netplan change status
  ansible.builtin.set_fact:
    k3s_netplan_changed: "{{ (netplan_template is defined) and netplan_template.changed }}"
